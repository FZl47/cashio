{% extends 'base/base_template.html' %}
{% load static %}
{% load i18n %}
{% load utils_tag %}

{% block Title %}
    {% trans "Journal Detail" %}  {{ object.name }}
{% endblock %}

{% block BodyClass %}
    has-rtl nk-body ui-rounder has-sidebar no-touch nk-nio-theme
{% endblock %}

{% block Content %}
    <div class="nk-app-root">
        <div class="nk-main">
            {% include 'base/components/menu.html' %}
            <div class="nk-wrap">
                {% include 'base/components/header.html' %}
                <div class="nk-content nk-content-fluid">
                    <div class="container-xl wide-xl">
                        <div class="nk-content-body">
                            <div class="nk-block-head nk-block-head-sm">
                                <div class="nk-block-between g-3">
                                    <div class="nk-block-head-content">
                                        <h3 class="nk-block-title page-title">
                                            {% trans "Journal Detail" %}
                                            <b>{{ object.name }}</b>
                                        </h3>
                                        <nav>
                                            <ul class="breadcrumb breadcrumb-arrow">
                                                <li class="breadcrumb-item"><a
                                                        href="{% url 'public:index' %}">{% trans "Home Page" %}</a></li>
                                                <li class="breadcrumb-item"><a>{% trans "Journals" %}</a></li>
                                                <li class="breadcrumb-item">
                                                    <a href="{% url 'accounting:journal__list' %}">
                                                        {% trans "Journal List" %}
                                                    </a>
                                                </li>
                                                <li class="breadcrumb-item"><a>{{ object.name }}</a></li>
                                            </ul>
                                        </nav>
                                    </div>
                                    <div class="nk-block-head-content d-flex justify-content-between gx-1">
                                        <div class="dropdown">
                                            <button
                                                    class="btn btn-outline-light bg-white d-none d-sm-inline-flex dropdown-toggle"
                                                    data-bs-toggle="dropdown">
                                                     <span>
                                                        {% trans "Actions" %}
                                                    </span>
                                                <em class="icon ni ni-setting"></em>
                                            </button>
                                            <button
                                                    class="btn btn-icon btn-outline-light bg-white d-inline-flex d-sm-none dropdown-toggle"
                                                    data-bs-toggle="dropdown">
                                                <em class="icon ni ni-setting">
                                                </em>
                                            </button>
                                            <div class="dropdown-menu">
                                                <ul class="link-list-opt">
                                                    {% if can_create_status %}
                                                        <li data-bs-toggle="modal"
                                                            data-bs-target="#modal-create-status-object">
                                                            <a class="d-flex justify-content-between text-success">
                                                                <span>{% trans "Create Status" %}</span>
                                                                <em class="icon ni ni-check-round-cut"></em>
                                                            </a>
                                                        </li>
                                                    {% endif %}
                                                    <li data-bs-toggle="modal"
                                                        data-bs-target="#modal-update-object">
                                                        <a class="d-flex justify-content-between text-info">
                                                            <span>{% trans "Edit" %}</span>
                                                            <em class="icon ni ni-pen2"></em>
                                                        </a>
                                                    </li>
                                                    <li data-bs-toggle="modal"
                                                        data-bs-target="#modal-delete-object">
                                                        <a class="d-flex justify-content-between text-danger">
                                                            <span>{% trans "Delete" %}</span>
                                                            <em class="icon ni ni-trash-empty"></em>
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="nk-block">
                                <div class="row gy-5">
                                    <div class="col-12 col-lg-6">
                                        <div class="nk-block-head">
                                            <div class="nk-block-head-content">
                                                <h5 class="nk-block-title title">{% trans "Basic Information" %}</h5>
                                            </div>
                                        </div>
                                        <div class="card">
                                            <ul class="data-list is-compact">
                                                <li class="data-item">
                                                    <div class="data-col">
                                                        <div class="data-label">{% trans "Name" %}</div>
                                                        <div class="data-value">{{ object.name }}</div>
                                                    </div>
                                                </li>
                                                <li class="data-item">
                                                    <div class="data-col">
                                                        <div class="data-label">{% trans "Code" %}</div>
                                                        <div class="data-value">{{ object.code }}</div>
                                                    </div>
                                                </li>
                                                <li class="data-item">
                                                    <div class="data-col">
                                                        <div class="data-label">{% trans "Creation Type" %}</div>
                                                        <div class="data-value">{{ object.get_creation_type_display }}</div>
                                                    </div>
                                                </li>
                                                <li class="data-item">
                                                    <div class="data-col">
                                                        <div class="data-label">{% trans "Created By" %}</div>
                                                        <div class="data-value">
                                                            {% if object.created_by %}
                                                                <a href="{{ object.created_by.get_absolute_url }}">
                                                                    {{ object.created_by.get_full_name }}
                                                                </a>
                                                            {% else %}
                                                                <span class="badge badge-dim bg-secondary">-</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="data-item">
                                                    <div class="data-col">
                                                        <div class="data-label">{% trans "Number of Lines" %}</div>
                                                        <div class="data-value">
                                                            <span class="badge badge-dim badge-sm bg-info">{{ object.get_lines.count }}</span>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="data-item">
                                                    <div class="data-col">
                                                        <div class="data-label">{% trans "Balance Status" %}</div>
                                                        <div class="data-value">
                                                            {% if object.is_balanced %}
                                                                <span class="badge bg-success">{% trans "Balanced" %}</span>
                                                            {% else %}
                                                                <span class="badge bg-warning">{% trans "Not Balanced" %}</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="data-item">
                                                    <div class="data-col">
                                                        <div class="data-label">{% trans "Balance/Unbalanced Amount" %}</div>
                                                        <div class="data-value">
                                                            {% with object.net_balance as balance %}
                                                                <span class="price-el">
                                                                    {{ balance.amount }}
                                                                </span>
                                                                <span class="currency-convert-label">{{ base_currency_code }}</span>
                                                                {% if balance.type == 'debit' %}
                                                                    <span class="badge badge-dim bg-warning">{% trans "Debit" %}</span>
                                                                {% elif balance.type == 'credit' %}
                                                                    <span class="badge badge-dim bg-warning">{% trans "Credit" %}</span>
                                                                {% endif %}
                                                            {% endwith %}
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="data-item">
                                                    <div class="data-col">
                                                        <div class="data-label">{% trans "Object Linked" %}</div>
                                                        <div class="data-value">
                                                            {% if object.object_linked %}
                                                                {% if object.object_linked.get_absolute_url %}
                                                                    <a href="{{ object.object_linked.get_absolute_url }}">
                                                                        {{ object.get_object_linked_repr }}
                                                                    </a>
                                                                {% else %}
                                                                    <span class="badge badge-dim bg-info">
                                                                        {{ object.get_object_linked_repr }}
                                                                    </span>
                                                                {% endif %}
                                                            {% else %}
                                                                <em class="icon ni ni-cross text-secondary"></em>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="data-item">
                                                    <div class="data-col">
                                                        <div class="data-label">{% trans "Attached File" %}</div>
                                                        <div class="data-value">
                                                            {% if object.get_attached_file_url %}
                                                                <a href="{{ object.get_attached_file_url }}">{% trans 'Visit' %}</a>
                                                            {% else %}
                                                                <span>
                                                                    <em class="icon ni ni-cross text-secondary"></em>
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="data-item">
                                                    <div class="data-col">
                                                        <div class="data-label">{% trans "Journal Date" %}</div>
                                                        <div class="data-value">
                                                            <span class="badge badge-dim bg-info">{{ object.get_date|default:'-' }}</span>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="data-item">
                                                    <div class="data-col">
                                                        <div class="data-label">{% trans "Created At" %}</div>
                                                        <div class="data-value">
                                                            <span class="badge badge-dim bg-info datetime-convert">{{ object.get_created_at|default:'-' }}</span>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="data-item">
                                                    <div class="data-col">
                                                        <div class="data-label">{% trans "Description" %}</div>
                                                        <div class="data-value">
                                                            <pre>{{ object.description|default:'-' }}</pre>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="col-12 col-lg-6">
                                        <div class="nk-block-head d-flex justify-content-between align-items-center">
                                            <div class="nk-block-head-content">
                                                <h5 class="nk-block-title title">
                                                    {% trans "Statuses" %}
                                                    <div class="text-center d-inline-block font-70">
                                                        {% if object.is_confirmed %}
                                                            <span class="text-success p-1">
                                                                (<span>{% trans 'Confirmed' %}</span>
                                                                <em class="icon ni ni-check-circle"></em>)
                                                            </span>
                                                        {% else %}
                                                            <span class="text-warning p-1">
                                                                (<span>{% trans 'UnConfirmed' %}</span>
                                                                <em class="icon ni ni-cross-circle"></em>)
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                </h5>
                                            </div>
                                            {% if can_create_status %}
                                                <button class="btn btn-outline-success" data-bs-toggle="modal"
                                                        data-bs-target="#modal-create-status-object">
                                                    <span>{% trans 'Create Status' %}</span>
                                                    <em class="icon ni ni-check-round-cut"></em>
                                                </button>
                                            {% endif %}
                                        </div>
                                        <div class="nk-block">
                                            <div class="card card-stretch">
                                                <div class="card-inner-group">
                                                    <div class="card-inner p-4">
                                                        <div>
                                                            <div class="progress" style="height: 32px">
                                                                <div class="progress-bar progress-bar-striped fs-18px {% if object.is_confirmed %}bg-success{% else %}bg-warning progress-bar-animated {% endif %}"
                                                                     data-progress="{{ object.get_status_progress }}">{{ object.get_confirmed_statuses.count }}/{{ object.get_journal_status_permissions_config.count }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="nk-tb-list nk-tb-tnx">
                                                            <div class="nk-tb-item nk-tb-head text-center">
                                                                <div class="nk-tb-col">
                                                                    <span>{% trans "Created By" %}</span></div>
                                                                <div class="nk-tb-col">
                                                                    <span>{% trans "Status" %}</span></div>
                                                                <div class="nk-tb-col">
                                                                    <span>{% trans "Attached File" %}</span></div>
                                                                <div class="nk-tb-col">
                                                                    <span>{% trans "Note" %}</span></div>
                                                                <div class="nk-tb-col">
                                                                    <span>{% trans "Created At" %}</span></div>
                                                            </div>
                                                            {% for j_status in object.get_statuses %}
                                                                <div class="nk-tb-item text-center">
                                                                    <div class="nk-tb-col">
                                                                        <a href="{{ j_status.created_by.get_absolute_url }}"><span>{{ j_status.created_by.get_full_name|truncatechars:'20' }}</span></a>
                                                                    </div>
                                                                    <div class="nk-tb-col">
                                                                        {% if j_status.status == 'pending' %}
                                                                            <span class="badge badge-dim bg-warning">{{ j_status.get_status_display }}</span>
                                                                        {% elif j_status.status == 'rejected' %}
                                                                            <span class="badge badge-dim bg-danger">{{ j_status.get_status_display }}</span>
                                                                        {% elif j_status.status == 'confirmed' %}
                                                                            <span class="badge badge-dim bg-success">{{ j_status.get_status_display }}</span>
                                                                        {% endif %}
                                                                    </div>
                                                                    <div class="nk-tb-col">
                                                                        {% if j_status.get_attached_file_url %}
                                                                            <a href="{{ j_status.get_attached_file_url }}">{% trans 'Visit' %}</a>
                                                                        {% else %}
                                                                            <span>
                                                                                <em class="icon ni ni-cross"></em>
                                                                            </span>
                                                                        {% endif %}
                                                                    </div>
                                                                    <div class="nk-tb-col">
                                                                        <span data-bs-toggle="tooltip"
                                                                              data-bs-placement="bottom"
                                                                              title="{{ j_status.note }}">{{ j_status.note|default:'-'|truncatechars:'20' }}</span>
                                                                    </div>
                                                                    <div class="nk-tb-col">
                                                                        <span class="datetime-convert font-80">{{ j_status.get_created_at }}</span>
                                                                    </div>
                                                                </div>
                                                            {% empty %}
                                                                <div class="container-not-found-base">
                                                                    <p>{% trans "Nothing Found" %}</p>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% if perms.accounting.view_journalentryline %}
                                <div class="nk-block">
                                    <div class="row gy-5">
                                        <div class="col-12">
                                            <div class="nk-block-head">
                                                <div class="nk-block-head-content">
                                                    <h5 class="nk-block-title title">{% trans "Lines" %}</h5>
                                                </div>
                                            </div>
                                            <div class="nk-block">
                                                <div class="card card-stretch">
                                                    <div class="card-inner-group">
                                                        <div class="card-inner p-2">
                                                            {% include 'accounting/journal_line/components/list-items.html' with journal_lines=object.get_lines %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% include 'base/components/footer.html' %}
            </div>
        </div>
        <div class="modal fade" tabindex="-1" id="modal-delete-object" aria-modal="true" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body modal-body-lg text-center">
                        <div class="nk-modal">
                            <em class="nk-modal-icon icon icon-circle icon-circle-xxl ni ni-trash-empty bg-danger"></em>
                            <h4 class="nk-modal-title">{% trans "Delete Journal" %}</h4>
                            <div class="nk-modal-text">
                                <p class="bg-outline-danger">
                                    {% trans "Are you sure you want to delete the journal" %}
                                    <b>{{ object.name }}</b>
                                    {% trans "All related items will be deleted and cannot be restored" %}
                                </p>
                            </div>
                            <div class="nk-modal-action mt-5">
                                <a class="btn btn-lg btn-mw btn-light m-1"
                                   data-bs-dismiss="modal">{% trans "Cancel" %}</a>
                                <a href="{% url 'accounting:journal__delete' pk=object.id %}"
                                   class="btn btn-lg btn-mw btn-danger m-1">{% trans "Yes, delete journal" %}</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" tabindex="-1" id="modal-update-object">
            <div class="modal-dialog modal-dialog-top" role="document">
                <div class="modal-content">
                    <a href="#" class="close" data-dismiss="modal" aria-label="{% trans "Close" %}">
                        <em class="icon ni ni-cross"></em>
                    </a>
                    <div class="modal-header">
                        <h5 class="modal-title">{% trans "Edit" %}</h5>
                    </div>
                    <div class="modal-body">
                        <form action="{% url 'accounting:journal__update' pk=object.id %}"
                              class="form-validate is-alter" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="row g-4">
                                <div class="col-12">
                                    <div class="form-group">
                                        <label class="form-label" for="name">{% trans "Name" %}</label>
                                        <div class="form-control-wrap">
                                            <input type="text" class="form-control" name="name"
                                                   placeholder="{% trans 'Journal Name' %}"
                                                   id="name" required value="{{ object.name|default:'' }}">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        <label class="form-label" for="code">{% trans "Code" %}</label>
                                        <div class="form-control-wrap">
                                            <input type="text" class="form-control" name="code"
                                                   placeholder="{% trans 'Journal Code' %}"
                                                   id="code" required value="{{ object.code|default:'' }}">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        <label class="form-label" for="date">{% trans "Journal Date" %}</label>
                                        <div class="form-control-wrap">
                                            <input type="text" class="form-control date-picker-alt" name="date"
                                                   placeholder="{% trans 'Journal Date' %}"
                                                   id="date" required value="{{ object.get_date|default:'' }}">
                                        </div>
                                        <div class="form-note">{% trans "Date format" %}
                                            <code>{% trans "day-month-year" %}</code></div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        <label class="form-label" for="description">{% trans "Description" %}</label>
                                        <div class="form-control-wrap">
                                                                <textarea name="description" id="description"
                                                                          class="form-control"
                                                                          placeholder="{% trans 'Description' %}">{{ object.description|default:'' }}</textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 text-left">
                                    <div class="form-group">
                                        <button type="submit" class="btn btn-lg btn-primary">
                                            {% trans "Update" %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {% if can_create_status %}
            <div class="modal fade" tabindex="-1" id="modal-create-status-object">
                <div class="modal-dialog modal-lg modal-dialog-top" role="document">
                    <div class="modal-content">
                        <a href="#" class="close" data-dismiss="modal" aria-label="{% trans "Close" %}">
                            <em class="icon ni ni-cross"></em>
                        </a>
                        <div class="modal-header">
                            <h5 class="modal-title">{% trans "Create Status" %}</h5>
                        </div>
                        <div class="modal-body">
                            <form action="{% url 'accounting:journal_status__create' pk=object.id %}"
                                  class="form-validate is-alter" method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="row g-4">
                                    <div class="col-12">
                                        <div class="form-group">
                                            <label class="form-label">{% trans 'Status' %}</label>
                                            <div class="form-control-wrap">
                                                <select class="form-select js-select2" name="status">
                                                    <option value="confirmed">{% trans 'Confirmed' %}</option>
                                                    <option value="rejected">{% trans 'Rejected' %}</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-group">
                                            <label class="form-label"
                                                   for="attach_file">{% trans 'Attach File' %}</label>
                                            <div class="form-control-wrap">
                                                <div class="form-file">
                                                    <input type="file" name="attached_file" class="form-file-input"
                                                           id="attach_file">
                                                    <label class="form-file-label"
                                                           for="attach_file">{% trans 'File' %}</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-group">
                                            <label class="form-label"
                                                   for="note">{% trans "Note" %}</label>
                                            <div class="form-control-wrap">
                                                                <textarea name="note" id="note"
                                                                          class="form-control"
                                                                          placeholder="{% trans 'Note' %}"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12 text-left">
                                        <div class="form-group">
                                            <button type="submit" class="btn btn-lg btn-primary">
                                                {% trans "Create" %}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}
